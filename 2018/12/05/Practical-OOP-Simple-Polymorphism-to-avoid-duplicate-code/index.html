<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Nishanth Mane"><title>Practical OOP - Simple Polymorphism to avoid duplicate code · Nishanth Mane</title><meta name="description" content="While working on a 2D Platformer game I was structuring and coming up with ideas to code NPC AI. To create the AI I chose the animator StateMachineBeh"><meta name="keywords" content="Unity3D, OpenGL, gamedev, computer-graphics, programming"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/timelify/animate.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/alex-chiru-042718-env-color-02-ac.jpg"><h3 title=""><a href="/">Nishanth Mane</a></h3><div class="description"><p>Write about daily coding experiences and game development.</p></div></div></div><ul class="social-links"><li><a href="https://www.linkedin.com/in/nishanth-mane-33065374"><i class="fa fa-linkedin"></i></a></li><li><a href="mailto:nishanth.engg93@gmail.com"><i class="fa fa-envelope"></i></a></li><li><a href="http://github.com/ngmgit"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by</span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io" target="_blank">Proudly published with Hexo&#65281;</a></div><p>Copyright &#169; 2018  Nishanth Mane.</p></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/projects">Projects</a></li><li><a href="/about">About</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"></a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Practical OOP - Simple Polymorphism to avoid duplicate code</a></h3></div><div class="post-content"><p>While working on a 2D Platformer game I was structuring and coming up with ideas to code NPC AI. To create the AI I chose the animator <code>StateMachineBehavior</code> (SMB) methodology. In this way I can have a State Machine based on NPC animator states thus giving me good control. NPCs in the game, in most of the cases have similar states say Idle, Walk, Attack, Hurt, Die as behaviour. Keeping this in mind I created a MonoBehavior Script which acts as the state for each of the NPC’s SMB scripts. So this will be the base script which has state as well as methods which can be used by SMB scripts.</p>
<p>SimpleNPCBase MonoBehavior Script - <a href="https://github.com/ngmgit/gameoff2018/blob/a8d2d8ddada6305406de11cfa7ef21336fbd0ca4/Assets/Scripts/NPC/SimpleNPCBase.cs" target="_blank" rel="noopener">link</a></p>
<p>In order for the SMB scripts to have access to the reference of this script instance w.r.t the gameobject Unity provides a way. <a href="https://unity3d.com/learn/tutorials/modules/beginner/5-pre-order-beta/state-machine-behaviours" target="_blank" rel="noopener">Communication between MonoBehaviours and StateMachineBehaviours</a></p>
<p>Checkout the scripts in example <a href="https://github.com/ngmgit/gameoff2018/tree/a8d2d8ddada6305406de11cfa7ef21336fbd0ca4/Assets/Scripts/NPC/UndeadGreen" target="_blank" rel="noopener">here</a><br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UndeadGreenFSMBase</span> : <span class="title">DefaultBaseFSM</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">HideInInspector</span>]</span><br><span class="line">	<span class="keyword">public</span> UndeadNPCScript MonoScriptRef;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UndeadIdleState</span>: <span class="title">UndeadGreenFSMBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// make use of the MonoScriptRef</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UndeadNPCScript</span> : <span class="title">SimpleNPCBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">        anim.GetBehaviour&lt;UndeadIdleState&gt;().MonoScriptRef = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This sets the variable <code>MonoScriptRef</code> of <code>UndeadGreenFSMBase</code> SMB script. Note here that the type of <code>MonoScripRef</code> is <code>UndeadNPCScript</code> which inherits from <code>SimpleNPCBase</code>.<br>So for every NPC I need to have a <code>&lt;Name\&gt;FSMBase</code> script  which has a member Type say <code>&lt;Name\&gt;NPCScript</code>.<br>Due to different <code>&lt;Name\&gt;FSMBase</code> script the SMB scripts cannot be reused. Then these cannot be reused and attached to the animator state as a SMB Script as <code>MonoScriptRef</code> Type changes from NPC to NPC. IdleState, WalkState are same for every NPC which falls under category simple and can be seen that it doesnt change at all in logic making redundant code usage all over the project.</p>

<div>
    <a href="/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/NPC-class-diag-before.png">

<img src="/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/NPC-class-diag-before.png">

</a></div>

<p>From the figure, Each MonoBehavior inheriting from <code>SimpleNPCBase</code> script in the leaf node will be attached to its NPC GameObject and the SMB scripts in the leaf node inherting from <code>DefaultBaseFSM</code> will be attached to the states of the animtor of the specific NPC GameObject which has animator component attached.</p>
<p>So we have to find a way to have Idle, Walk, etc as base scripts which can be applied to any Simple NPC. The issue which is stopping us from resusing those scripts is the reference to MonoBehavior script i.e <code>MonoScriptRef</code> variable in our case whose type changes from NPC to NPC i.e UndeadNPCScript, BanditNPCScript etc.</p>
<h4 id="Fix-and-remove-redundant-script-files"><a href="#Fix-and-remove-redundant-script-files" class="headerlink" title="Fix and remove redundant script files"></a>Fix and remove redundant script files</h4><p>To resolve this issue I made use of polymorphism concept. Since all the Simple NPC MonoBehavior script inherit from <code>SimpleNPCBase</code> the <code>DefaultBaseFSM</code> will now have a variable <code>MonoScriptRef</code> of type <code>SimpleNPCBase</code>. This way from every script which inherits from <code>SimpleNPCBase</code> can set the reference it self in the SMB scripts using the following statements.</p>
<p>And also create default SMB scripts like Idle, Walk, Attack, Hurt.</p>
<p>All these can be clearly seen by comparing the above and below class diagram.</p>
<p>Note: The variable type of <code>MonoScriptRef</code> after change and before change. Before change we had to make it same as that of the derived ones. i.e <code>UndeadNPCScript</code> for <a href="https://github.com/ngmgit/gameoff2018/blob/master/Assets/Scripts/NPC/DefaultBaseFSM.cs" target="_blank" rel="noopener">below</a> script.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DefaultBaseFSM</span></span><br><span class="line">&#123;</span><br><span class="line">	[<span class="meta">HideInInspector</span>]</span><br><span class="line">	<span class="keyword">public</span> SimpleNPCBase MonoScriptRef;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UndeadNPCScript</span> : <span class="title">SimpleNPCBase</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// other init statemnts</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// initialize the behavior scripts</span></span><br><span class="line">        anim.GetBehaviour&lt;IdleSMB&gt;().MonoScriptRef = <span class="keyword">this</span>;</span><br><span class="line">        anim.GetBehaviour&lt;WalkSMB&gt;().MonoScriptRef = <span class="keyword">this</span>;</span><br><span class="line">        anim.GetBehaviour&lt;AttackSMB&gt;().MonoScriptRef = <span class="keyword">this</span>;</span><br><span class="line">        anim.GetBehaviour&lt;HurtSMB&gt;().MonoScriptRef = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div>
    <a href="/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/NPC-class-diag-after.png">

<img src="/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/NPC-class-diag-after.png">

</a></div>

<h4 id="Before-vs-After"><a href="#Before-vs-After" class="headerlink" title="Before vs After"></a>Before vs After</h4><p>Before:</p>
<ul>
<li>For each NPC MonoBehavior script had to create a <code>&lt;Name\&gt;BaseFSM</code> with <code>MonoScriptRef</code> variable whose type is same as that of the MonoBehaviour script.<br>Eg: For <code>UndeadNPCScript</code> its relevant SMB <code>UndeadGreenFSMBase</code> needs a <code>MonoScriptRef</code> variable of type <code>UndeadNPCScript</code>.</li>
<li>Had to duplicate and create SMB script files with same logic for each of the  states Idle, Walk, Attack, Hurt.</li>
</ul>
<p>After:</p>
<ul>
<li>Avoid duplicate SMB scripts and have default ones like IdleSMB, WalkSMB, AttackSMB, HurtSMB.<br>From the diagram it can be seen that at first level there are default SMB scripts which can be used by any Simple NPC and in second level NPC which has additional states like AttackIdle can have a its own SMB script which can be easily added in the current setup.</li>
<li>MonoBehavior script reference now has a type <code>SimpleNPCBase</code> which will be automatically casted when the reference is set using the following statement.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">anim.GetBehaviour&lt;IdleSMB&gt;().MonoScriptRef = this;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Also checkout the file structure <a href="https://github.com/ngmgit/gameoff2018/tree/a8d2d8ddada6305406de11cfa7ef21336fbd0ca4/Assets/Scripts/NPC" target="_blank" rel="noopener">before</a> vs <a href="https://github.com/ngmgit/gameoff2018/blob/master/Assets/Scripts/NPC" target="_blank" rel="noopener">after</a>.</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-12-05</span><i class="fa fa-comment-o"></i><a href="/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/#comments">Comments</a><i class="fa fa-tag"></i><a class="tag" href="/categories/Programming/" title="Programming">Programming </a><a class="tag" href="/categories/Programming/Unity3D/" title="Unity3D">Unity3D </a><a class="tag" href="/categories/Programming/c-sharp/" title="C#">C# </a><a class="tag" href="/tags/c-sharp/" title="c#">c# </a><a class="tag" href="/tags/OOP/" title="OOP">OOP </a><a class="tag" href="/tags/unity-3d/" title="unity-3d">unity-3d </a><a class="tag" href="/tags/game-dev/" title="game-dev">game-dev </a><a class="tag" href="/tags/polymorphism/" title="polymorphism">polymorphism </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="http://www.evernote.com/clip.action?url=http://ngmgit.github.com/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/&amp;t=Practical OOP - Simple Polymorphism to avoid duplicate code"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/share?text=Practical OOP - Simple Polymorphism to avoid duplicate code&amp;url=http://ngmgit.github.com/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/"></a></div><div class="linked-in"><a class="fa fa-linkedin" href="https://www.linkedin.com/shareArticle?url=http://ngmgit.github.com/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/&amp;mini=true&amp;title=Practical OOP - Simple Polymorphism to avoid duplicate code"></a></div><div class="reddit"><a class="fa fa-reddit" href="http://www.reddit.com/submit?url=http://ngmgit.github.com/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/&amp;title=Practical OOP - Simple Polymorphism to avoid duplicate code"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/10/18/Setup-Cpp-in-VSCode-Windows-GCC-GDB/" title="Setup C++ in VSCode Windows: GCC + GDB">next_post</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'ngmgit-github-io';
var disqus_identifier = '2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/';
var disqus_title = 'Practical OOP - Simple Polymorphism to avoid duplicate code';
var disqus_url = 'http://ngmgit.github.com/2018/12/05/Practical-OOP-Simple-Polymorphism-to-avoid-duplicate-code/';

var disqus_config = function() {
    this.page.url = disqus_url;
    this.page.identifier = disqus_identifier;
};

(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//ngmgit-github-io.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script><script id="dsq-count-scr" src="//ngmgit-github-io.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>